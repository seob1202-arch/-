<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Global Market | 글로벌 한인장터</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/variable/pretendardvariable.min.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Pretendard Variable', 'sans-serif'],
          },
          colors: {
            primary: '#4F46E5', // Indigo 600
            primaryHover: '#4338CA', // Indigo 700
            secondary: '#64748B', // Slate 500
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #F8FAFC; color: #1E293B; }
    
    /* Custom Scrollbar for horizontal lists */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Loader */
    .loader {
      border: 3px solid #E2E8F0;
      border-top: 3px solid #4F46E5;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Input Style Utility Class (입력창 공통 스타일) */
    .input-field {
        width: 100%;
        border-radius: 0.5rem; /* rounded-lg */
        border-width: 1px;
        border-color: #CBD5E1; /* border-slate-300 (진한 테두리) */
        background-color: #FFFFFF;
        padding-left: 1rem; /* px-4 (좌측 여백 확보) */
        padding-right: 1rem;
        padding-top: 0.75rem; /* py-3 (높이 확보) */
        padding-bottom: 0.75rem;
        font-size: 0.875rem; /* text-sm */
        color: #0F172A; /* text-slate-900 (진한 글자색/커서) */
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
    }
    .input-field:focus {
        border-color: #4F46E5; /* focus:border-primary */
        outline: none;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); /* focus:ring */
    }
    .input-field::placeholder {
        color: #94A3B8; /* placeholder-slate-400 */
    }

    /* Modal Animation */
    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    .modal-exit { opacity: 1; transform: scale(1); }
    .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
    
    /* Image Aspect Ratio */
    .aspect-card { aspect-ratio: 4/3; }
  </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwy1uUhHzf8POaho6P5thoCeiFQvsMVS7vEtmgy-sY3e2nWMkb9JzN26OW5TObDEDWZTA/exec"; 
  </script>

  <nav class="sticky top-0 z-40 w-full bg-white/80 backdrop-blur-md border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-2 cursor-pointer group" onclick="showPage('list')">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg group-hover:shadow-indigo-500/30 transition-all duration-300">
            <i class="fa-solid fa-earth-americas text-xl"></i>
          </div>
          <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600">글로벌 한인장터</span>
        </div>

        <button onclick="showPage('write')" class="hidden md:flex items-center gap-2 bg-primary hover:bg-primaryHover text-white px-5 py-2.5 rounded-full font-semibold text-sm transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
          <i class="fa-solid fa-pen"></i> 상품 등록하기
        </button>
      </div>
    </div>
  </nav>

  <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
    
    <div id="list-page">
      
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
          <div class="md:col-span-2 relative">
            <i class="fa-solid fa-globe absolute left-3 top-3.5 text-slate-400 z-10"></i>
            <select id="filter-country" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none cursor-pointer transition-colors hover:bg-slate-100 appearance-none text-slate-900" onchange="filterItems()">
              <option value="">전체 국가</option>
            </select>
          </div>
          <div class="md:col-span-3 relative">
            <i class="fa-solid fa-location-dot absolute left-3 top-3.5 text-slate-400 z-10"></i>
            <input type="text" id="filter-city" placeholder="도시 (예: 런던)" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-900 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-colors hover:bg-slate-100 placeholder-slate-400" onkeyup="filterItems()">
          </div>
          <div class="md:col-span-3 relative">
            <i class="fa-solid fa-layer-group absolute left-3 top-3.5 text-slate-400 z-10"></i>
            <select id="filter-category" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium text-slate-900 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none cursor-pointer transition-colors hover:bg-slate-100 appearance-none" onchange="filterItems()">
              <option value="">모든 카테고리</option>
              <option value="디지털/가전">디지털/가전</option>
              <option value="가구/인테리어">가구/인테리어</option>
              <option value="생활/가공식품">생활/가공식품</option>
              <option value="유아동/출산">유아동/출산</option>
              <option value="의류/잡화">의류/잡화</option>
              <option value="기타">기타</option>
            </select>
          </div>
          <div class="md:col-span-4 relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-slate-400 z-10"></i>
            <input type="text" id="filter-keyword" placeholder="상품명, 설명 등 검색" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-900 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-colors hover:bg-slate-100 placeholder-slate-400" onkeyup="filterItems()">
          </div>
        </div>
      </div>

      <div id="loading" class="flex flex-col items-center justify-center py-20">
        <div class="loader mb-4"></div>
        <p class="text-slate-500 font-medium animate-pulse">상품을 불러오는 중입니다...</p>
      </div>

      <div id="item-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
      
      <div id="no-data" class="hidden flex flex-col items-center justify-center py-20 text-slate-400">
        <i class="fa-regular fa-folder-open text-6xl mb-4 text-slate-200"></i>
        <p class="text-lg font-medium">등록된 물품이 없습니다.</p>
        <p class="text-sm mt-1">첫 번째 상품을 등록해보세요!</p>
      </div>
    </div>

    <div id="write-page" class="hidden max-w-2xl mx-auto">
      <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
          <h2 class="text-xl font-bold text-slate-800">새로운 물품 등록</h2>
          <button onclick="showPage('list')" class="text-slate-400 hover:text-slate-600 transition-colors">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <form id="upload-form" onsubmit="handleUpload(event)" class="p-6 space-y-6">
          
          <div class="space-y-4">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">위치 및 카테고리</h3>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">국가 <span class="text-red-500">*</span></label>
                <select name="country" id="input-country" class="input-field cursor-pointer" required onchange="handleCountryChange(this.value)">
                  <option value="">국가 선택</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">도시 <span class="text-red-500">*</span></label>
                <input type="text" name="city" class="input-field" placeholder="예: 밴쿠버" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">카테고리 <span class="text-red-500">*</span></label>
              <select name="category" class="input-field cursor-pointer" required>
                <option value="디지털/가전">디지털/가전</option>
                <option value="가구/인테리어">가구/인테리어</option>
                <option value="생활/가공식품">생활/가공식품</option>
                <option value="유아동/출산">유아동/출산</option>
                <option value="의류/잡화">의류/잡화</option>
                <option value="기타">기타</option>
              </select>
            </div>
          </div>

          <hr class="border-slate-100">

          <div class="space-y-4">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">상품 상세 정보</h3>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">상품명 <span class="text-red-500">*</span></label>
              <input type="text" name="title" class="input-field" placeholder="상품명을 입력하세요" required>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">상세 설명 <span class="text-red-500">*</span></label>
              <textarea name="description" class="input-field h-32 resize-none leading-relaxed" placeholder="상품의 상태, 구매 시기 등을 자세히 적어주세요." required></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
               <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">사용 기간</label>
                <select name="usage" class="input-field cursor-pointer">
                  <option value="미개봉">미개봉</option>
                  <option value="1개월 미만">1개월 미만</option>
                  <option value="1~6개월">1~6개월</option>
                  <option value="6개월~1년">6개월~1년</option>
                  <option value="1년 이상">1년 이상</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">거래 방법</label>
                <div class="flex gap-4 mt-3">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="delivery" value="직거래" checked class="w-4 h-4 text-primary focus:ring-primary border-slate-300">
                    <span class="text-sm font-medium text-slate-700">직거래</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="delivery" value="택배" class="w-4 h-4 text-primary focus:ring-primary border-slate-300">
                    <span class="text-sm font-medium text-slate-700">택배</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                 <label class="block text-sm font-bold text-slate-700 mb-2">판매 가격 <span class="text-red-500">*</span></label>
                 <div class="relative">
                   <input type="text" name="currency" id="currency-input" class="absolute left-0 top-0 bottom-0 w-14 text-center bg-slate-50 border border-r-0 border-slate-300 rounded-l-lg text-slate-600 text-sm font-bold z-10" readonly tabindex="-1">
                   <input type="number" name="price" class="input-field pl-16 rounded-l-none" placeholder="0" required>
                 </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">판매 종료일 <span class="text-red-500">*</span></label>
                <input type="date" name="endDate" class="input-field text-slate-600 cursor-pointer" required>
              </div>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">사진 등록 (최대 3장)</label>
              <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:bg-slate-50 hover:border-primary/50 transition-all cursor-pointer relative group">
                 <input type="file" id="img-input" accept="image/*" multiple onchange="handleImagePreview(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                 <div class="text-slate-400 group-hover:text-primary transition-colors">
                   <div class="bg-slate-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-indigo-50">
                     <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                   </div>
                   <p class="text-sm font-medium text-slate-600">클릭하여 이미지를 업로드하세요</p>
                   <p class="text-xs text-slate-400 mt-1">PNG, JPG (최대 3장)</p>
                 </div>
              </div>
              <div id="preview-container" class="flex gap-3 mt-4 overflow-x-auto pb-2 no-scrollbar"></div>
            </div>
          </div>

          <hr class="border-slate-100">

          <div class="space-y-4">
             <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">연락처 및 관리</h3>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">전화번호</label>
                <input type="text" name="phone" id="phone-input" class="input-field" placeholder="국가 코드 자동 입력">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">카카오톡 ID</label>
                <input type="text" name="kakaoId" class="input-field" placeholder="ID 입력">
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">오픈채팅 URL</label>
              <input type="text" name="openChat" class="input-field" placeholder="https://open.kakao.com/...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">관리 비밀번호 <span class="text-red-500">*</span></label>
              <input type="password" name="password" class="input-field border-orange-200 focus:border-orange-500 focus:ring-orange-200 bg-orange-50/30" placeholder="게시글 삭제/수정 시 필요합니다" required>
            </div>
          </div>

          <div class="pt-4 flex gap-3">
             <button type="button" onclick="showPage('list')" class="flex-1 bg-white border border-slate-300 text-slate-700 py-3.5 rounded-xl font-bold hover:bg-slate-50 transition-all">취소</button>
             <button type="submit" id="submit-btn" class="flex-1 bg-primary text-white py-3.5 rounded-xl font-bold hover:bg-primaryHover shadow-lg shadow-indigo-200 transition-all">등록 완료</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <div id="detail-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0 modal-bg" onclick="closeModal('detail-modal')"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 scale-95 modal-panel border border-slate-100">
          
          <button onclick="closeModal('detail-modal')" class="absolute top-4 right-4 z-20 w-8 h-8 flex items-center justify-center rounded-full bg-black/20 hover:bg-black/40 text-white backdrop-blur-md transition-all">
            <i class="fa-solid fa-xmark"></i>
          </button>

          <div id="modal-images" class="w-full h-80 bg-slate-100 flex overflow-x-auto snap-x snap-mandatory no-scrollbar">
            </div>

          <div class="p-6 sm:p-8">
            <div class="flex justify-between items-start mb-3">
              <div class="flex gap-2 text-xs font-bold uppercase tracking-wide">
                <span id="modal-country-city" class="bg-indigo-50 text-indigo-700 px-2.5 py-1 rounded-md"></span>
                <span id="modal-category" class="bg-slate-100 text-slate-600 px-2.5 py-1 rounded-md"></span>
              </div>
              <span id="modal-time-left" class="text-xs font-bold text-rose-500 border border-rose-100 bg-rose-50 px-2 py-1 rounded-md"></span>
            </div>

            <h3 id="modal-title" class="text-2xl font-bold text-slate-900 mb-2 leading-tight break-words"></h3>
            <p id="modal-price" class="text-2xl font-bold text-primary mb-6"></p>

            <div class="grid grid-cols-3 gap-2 mb-6 text-sm text-slate-600 bg-slate-50 p-4 rounded-xl border border-slate-100">
               <div class="text-center border-r border-slate-200 last:border-0">
                 <i class="fa-solid fa-box text-slate-400 mb-1 block"></i>
                 <span id="modal-usage" class="font-medium"></span>
               </div>
               <div class="text-center border-r border-slate-200 last:border-0">
                 <i class="fa-solid fa-truck text-slate-400 mb-1 block"></i>
                 <span id="modal-delivery" class="font-medium"></span>
               </div>
               <div class="text-center">
                 <i class="fa-regular fa-clock text-slate-400 mb-1 block"></i>
                 <span id="modal-end-date" class="font-medium"></span>
               </div>
            </div>

            <div class="prose prose-sm prose-slate max-w-none mb-8">
              <p id="modal-desc" class="whitespace-pre-wrap text-slate-600 leading-relaxed"></p>
            </div>

            <div class="space-y-3">
              <button id="btn-phone" class="hidden w-full bg-green-500 hover:bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-phone"></i>
              </button>
              <button id="btn-kakao-copy" class="hidden w-full bg-[#FEE500] hover:bg-[#FDD835] text-slate-900 py-3.5 rounded-xl font-bold shadow-lg shadow-yellow-200 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-comment"></i> 카카오톡 ID 복사
              </button>
              <button id="btn-open-chat" class="hidden w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-3.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> 오픈채팅 입장
              </button>
            </div>

            <div class="mt-6 pt-6 border-t border-slate-100 flex justify-end">
              <button onclick="openDeleteModal()" class="text-xs text-slate-400 hover:text-red-500 underline transition-colors">이 게시글 삭제하기</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="password-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal('password-modal')"></div>
    <div class="relative bg-white rounded-xl shadow-xl p-6 w-full max-w-xs transform scale-100 transition-all border border-slate-100">
      <h3 class="text-lg font-bold text-slate-900 mb-2">삭제 확인</h3>
      <p class="text-sm text-slate-500 mb-4">등록 시 설정한 비밀번호를 입력해주세요.</p>
      <input type="password" id="delete-password" class="w-full rounded-lg border-slate-300 focus:border-red-500 focus:ring-red-200 text-sm mb-4 px-3 py-2" placeholder="비밀번호 4자리">
      <div class="flex gap-2">
        <button onclick="closeModal('password-modal')" class="flex-1 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-bold transition-colors">취소</button>
        <button onclick="submitDelete()" class="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold shadow-md shadow-red-200 transition-colors">삭제</button>
      </div>
    </div>
  </div>

  <button onclick="showPage('write')" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-primary text-white rounded-full shadow-xl shadow-indigo-500/40 flex items-center justify-center text-2xl z-40 transition-transform active:scale-90 hover:bg-primaryHover">
    <i class="fa-solid fa-plus"></i>
  </button>

  <script>
    // --- Data & Config ---
    const COUNTRY_DATA = {
        '한국': { code: '+82', currency: '₩' }, '미국': { code: '+1', currency: '$' }, '캐나다': { code: '+1', currency: 'C$' }, '일본': { code: '+81', currency: '¥' }, '중국': { code: '+86', currency: '¥' }, '호주': { code: '+61', currency: 'A$' }, '뉴질랜드': { code: '+64', currency: 'NZ$' }, '영국': { code: '+44', currency: '£' }, '독일': { code: '+49', currency: '€' }, '프랑스': { code: '+33', currency: '€' }, '베트남': { code: '+84', currency: '₫' }, '필리핀': { code: '+63', currency: '₱' }, '태국': { code: '+66', currency: '฿' }, '싱가포르': { code: '+65', currency: 'S$' }, '말레이시아': { code: '+60', currency: 'RM' }, '인도네시아': { code: '+62', currency: 'Rp' }, '브라질': { code: '+55', currency: 'R$' }, '러시아': { code: '+7', currency: '₽' }, '우즈베키스탄': { code: '+998', currency: 'som' }, '카자흐스탄': { code: '+7', currency: '₸' }
    };

    let allItems = [];
    let currentDetailId = null;
    let selectedImages = [];

    // --- API Utilities ---
    async function apiFetch(method, body = null) {
      if (GAS_API_URL.includes("여기에")) {
        alert("GAS 웹 앱 URL을 설정해주세요.");
        return null;
      }
      const options = { method: method };
      if (method === 'POST' && body) {
        options.body = JSON.stringify(body);
        options.headers = { "Content-Type": "text/plain;charset=utf-8" };
      }
      try {
        const response = await fetch(GAS_API_URL, options);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return await response.json();
      } catch (error) {
        alert("통신 오류: " + error.message);
        return null;
      }
    }

    // --- Initialization ---
    window.onload = function() {
      initCountryOptions();
      fetchItems();
    };

    function initCountryOptions() {
        const selectFilter = document.getElementById('filter-country');
        const selectInput = document.getElementById('input-country');
        Object.keys(COUNTRY_DATA).sort().forEach(country => {
            selectFilter.appendChild(new Option(country, country));
            selectInput.appendChild(new Option(country, country));
        });
    }

    function handleCountryChange(val) {
        const data = COUNTRY_DATA[val];
        if (data) {
            document.getElementById('currency-input').value = data.currency;
            document.getElementById('phone-input').value = data.code + ' ';
        } else {
            document.getElementById('currency-input').value = '';
            document.getElementById('phone-input').value = '';
        }
    }

    function showPage(pageId) {
      const listPage = document.getElementById('list-page');
      const writePage = document.getElementById('write-page');
      
      if (pageId === 'list') {
        writePage.classList.add('hidden');
        listPage.classList.remove('hidden');
        fetchItems();
        window.scrollTo(0, 0);
      } else {
        listPage.classList.add('hidden');
        writePage.classList.remove('hidden');
        window.scrollTo(0, 0);
      }
    }

    // --- Fetch & Render ---
    async function fetchItems() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('item-grid').innerHTML = '';
      document.getElementById('no-data').classList.add('hidden');

      const data = await apiFetch('GET');
      
      document.getElementById('loading').classList.add('hidden');
      if (data) {
        allItems = data;
        renderItems(allItems);
      }
    }

    function renderItems(items) {
      const grid = document.getElementById('item-grid');
      grid.innerHTML = '';
      if (items.length === 0) {
        document.getElementById('no-data').classList.remove('hidden');
        return;
      }
      
      items.forEach((item, index) => {
        let images = [];
        try { images = JSON.parse(item.images); } catch(e) {}
        const thumb = images.length > 0 ? images[0] : 'https://via.placeholder.com/400x300?text=No+Image&bg=E2E8F0&fc=94A3B8';
        
        const endD = new Date(item.endDate);
        const diffDays = Math.ceil((endD - new Date()) / (1000 * 60 * 60 * 24));
        
        let badgeClass = "bg-slate-100 text-slate-600";
        let dDayText = `D-${diffDays}`;
        if (diffDays < 0) { dDayText = "마감됨"; badgeClass="bg-slate-200 text-slate-400"; }
        else if (diffDays === 0) { dDayText = "오늘 마감"; badgeClass="bg-rose-100 text-rose-600 font-bold"; }
        else if (diffDays <= 3) { badgeClass="bg-orange-100 text-orange-600 font-bold"; }

        const div = document.createElement('div');
        // Card Animation Delay
        div.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s both`;
        div.className = "group bg-white rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden border border-slate-200 flex flex-col h-full";
        div.onclick = () => openDetail(item);
        
        div.innerHTML = `
          <div class="aspect-card bg-slate-100 overflow-hidden relative">
            <img src="${thumb}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="absolute bottom-3 left-3 right-3 flex justify-between items-end opacity-0 group-hover:opacity-100 transition-opacity duration-300 translate-y-2 group-hover:translate-y-0">
               <span class="text-white text-xs font-medium bg-black/30 backdrop-blur-sm px-2 py-1 rounded-lg border border-white/20">${item.city}</span>
            </div>
            <div class="absolute top-3 left-3">
               <span class="text-[10px] font-bold uppercase tracking-wider text-slate-700 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md shadow-sm border border-slate-100">${item.country}</span>
            </div>
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <div class="flex justify-between items-start gap-2 mb-2">
               <h3 class="font-bold text-slate-800 line-clamp-1 group-hover:text-primary transition-colors">${item.title}</h3>
               <span class="text-[10px] whitespace-nowrap px-1.5 py-0.5 rounded ${badgeClass}">${dDayText}</span>
            </div>
            <p class="text-xs text-slate-500 mb-3 truncate">${item.category} · ${item.usage}</p>
            <div class="mt-auto pt-3 border-t border-slate-50 flex justify-between items-center">
              <span class="text-lg font-bold text-primary">${item.currency} ${Number(item.price).toLocaleString()}</span>
              <span class="text-xs text-slate-400 group-hover:text-primary transition-colors">자세히 보기 <i class="fa-solid fa-arrow-right ml-1"></i></span>
            </div>
          </div>
        `;
        grid.appendChild(div);
      });
    }

    // Inject Keyframes for Card Animation
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(styleSheet);

    function filterItems() {
      const country = document.getElementById('filter-country').value;
      const city = document.getElementById('filter-city').value.toLowerCase();
      const category = document.getElementById('filter-category').value;
      const keyword = document.getElementById('filter-keyword').value.toLowerCase();

      const filtered = allItems.filter(item => {
        return (country === "" || item.country === country) &&
               (city === "" || item.city.toLowerCase().includes(city)) &&
               (category === "" || item.category === category) &&
               (keyword === "" || item.title.toLowerCase().includes(keyword) || item.description.toLowerCase().includes(keyword));
      });
      renderItems(filtered);
    }

    // --- Modal Logic ---
    function openDetail(item) {
      currentDetailId = item.id;
      const modal = document.getElementById('detail-modal');
      const bg = modal.querySelector('.modal-bg');
      const panel = modal.querySelector('.modal-panel');
      
      // Data Binding
      document.getElementById('modal-title').textContent = item.title;
      document.getElementById('modal-country-city').textContent = `${item.country} · ${item.city}`;
      document.getElementById('modal-category').textContent = item.category;
      document.getElementById('modal-price').textContent = `${item.currency} ${Number(item.price).toLocaleString()}`;
      document.getElementById('modal-usage').textContent = item.usage;
      document.getElementById('modal-delivery').textContent = item.delivery;
      document.getElementById('modal-end-date').textContent = item.endDate.split('T')[0];
      document.getElementById('modal-desc').textContent = item.description;

      const endD = new Date(item.endDate);
      const diff = Math.ceil((endD - new Date()) / (1000*60*60*24));
      const timeLeft = document.getElementById('modal-time-left');
      if(diff < 0) { timeLeft.textContent = "판매 종료"; timeLeft.className = "text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-md"; }
      else { timeLeft.textContent = diff === 0 ? "오늘 마감" : `${diff}일 남음`; timeLeft.className = "text-xs font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded-md"; }

      // Images
      const imgContainer = document.getElementById('modal-images');
      imgContainer.innerHTML = '';
      let images = [];
      try { images = JSON.parse(item.images); } catch(e) {}
      
      if(images.length === 0) {
        imgContainer.innerHTML = '<div class="w-full h-full flex flex-col items-center justify-center text-slate-300"><i class="fa-regular fa-image text-4xl mb-2"></i><span>이미지 없음</span></div>';
      } else {
        images.forEach(src => {
          const img = document.createElement('img');
          img.src = src;
          img.className = "snap-center w-full h-full object-contain bg-black/5";
          imgContainer.appendChild(img);
        });
      }

      // Buttons
      const setupBtn = (id, val, clickHandler, textHtml) => {
        const el = document.getElementById(id);
        if(val) { 
            el.classList.remove('hidden'); 
            el.onclick = clickHandler; 
            if(textHtml) el.innerHTML = textHtml; 
        }
        else el.classList.add('hidden');
      };

      setupBtn('btn-phone', item.phone, () => {
         window.location.href = `tel:${item.phone}`;
      }, `<i class="fa-solid fa-phone"></i> 연락하기 (${item.phone})`);

      setupBtn('btn-kakao-copy', item.kakaoId, () => navigator.clipboard.writeText(item.kakaoId).then(() => alert('카카오톡 ID가 클립보드에 복사되었습니다.')));
      setupBtn('btn-open-chat', (item.openChat && item.openChat.startsWith('http')), () => window.open(item.openChat, '_blank'));

      // Animation Open
      modal.classList.remove('hidden');
      setTimeout(() => {
        bg.classList.remove('opacity-0');
        panel.classList.remove('opacity-0', 'scale-95');
      }, 10);
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if(id === 'detail-modal') {
        const bg = modal.querySelector('.modal-bg');
        const panel = modal.querySelector('.modal-panel');
        bg.classList.add('opacity-0');
        panel.classList.add('opacity-0', 'scale-95');
        setTimeout(() => modal.classList.add('hidden'), 200);
      } else {
        modal.classList.add('hidden');
      }
    }

    function openDeleteModal() {
        document.getElementById('password-modal').classList.remove('hidden');
        document.getElementById('delete-password').value = '';
    }

    async function submitDelete() {
        const pw = document.getElementById('delete-password').value;
        if(!pw) return alert('비밀번호를 입력하세요.');
        const btn = document.querySelector('#password-modal button.bg-red-500');
        const originText = btn.textContent;
        btn.textContent = '처리중...';
        
        const res = await apiFetch('POST', { action: 'delete', id: currentDetailId, password: pw });
        btn.textContent = originText;
        if(res && res.success) {
            alert('게시글이 삭제되었습니다.');
            closeModal('password-modal');
            closeModal('detail-modal');
            fetchItems();
        } else {
            alert(res ? res.message : '삭제 실패 (비밀번호를 확인해주세요)');
        }
    }

    // --- Upload Logic ---
    function handleImagePreview(input) {
      const container = document.getElementById('preview-container');
      container.innerHTML = '';
      selectedImages = [];
      Array.from(input.files).slice(0, 3).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxW = 600; 
            const scale = maxW / img.width;
            canvas.width = maxW;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
            selectedImages.push(dataUrl);
            
            // Preview UI
            const thumb = document.createElement('div');
            thumb.className = "relative w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 shadow-sm group";
            thumb.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
            container.appendChild(thumb);
          }
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function handleUpload(e) {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 저장 중...';
      const form = document.getElementById('upload-form');
      
      const formData = {
        action: 'create',
        country: form.country.value,
        city: form.city.value,
        category: form.category.value,
        title: form.title.value,
        description: form.description.value,
        usage: form.usage.value,
        delivery: form.delivery.value,
        currency: form.currency.value,
        price: form.price.value,
        endDate: form.endDate.value,
        phone: form.phone.value,
        kakaoId: form.kakaoId.value,
        openChat: form.openChat.value,
        password: form.password.value,
        images: selectedImages
      };

      const res = await apiFetch('POST', formData);
      btn.disabled = false;
      btn.textContent = originalText;
      
      if(res && res.success) {
        alert("성공적으로 등록되었습니다!");
        form.reset();
        document.getElementById('preview-container').innerHTML = '';
        selectedImages = [];
        showPage('list');
      } else {
        alert("등록 실패: " + (res ? res.error : '알 수 없는 오류'));
      }
    }
  </script>
</body>
</html>
